# Claude Context for imgc Development

## Project Identity
**imgc** (Intelligent Image Compression Watcher) - A professional-grade Python application for automatic image compression with real-time file system monitoring.

## Development Status
- **Current Version**: 0.0.2 (ready for release)
- **Maturity**: Production-ready with comprehensive testing and documentation
- **Test Coverage**: 27 tests covering all major functionality
- **Platform Support**: Windows, macOS, Linux (x64 and ARM64)
- **License**: MIT

## Core Functionality
1. **File System Monitoring**: Real-time watching for new image files
2. **Image Compression**: Automatic optimization of JPEG, PNG, WebP, AVIF
3. **Operating Modes**: 
   - Watch-only (default): Process only new files
   - Scan+watch (--process-existing): Process existing files then watch
4. **Multi-threading**: Configurable worker threads for batch processing
5. **Cross-platform**: Handles Windows/POSIX path differences correctly

## Architecture Principles
- **Makefile-centric**: All operations go through Makefile for consistency
- **Modular design**: Clear separation between CLI, watching, compression, config
- **Testable code**: Extracted pure functions, comprehensive mocking
- **Error resilience**: Timeout handling, graceful degradation, helpful messages
- **Configuration flexibility**: CLI args + environment variables + sensible defaults

## Key Technical Decisions
1. **Default to watch-only mode**: Faster startup, less resource usage
2. **pathlib.Path everywhere**: Cross-platform compatibility
3. **Daemon threads**: Non-blocking background processing
4. **Type hints throughout**: Better IDE support and code clarity
5. **Extracted parsing functions**: Improved testability and maintainability

## Build and Release System
- **Local builds**: `make build` creates PyInstaller binaries
- **Automated releases**: GitHub Actions builds all platforms on tag creation
- **Cross-platform CI**: Tests on Windows, macOS, Linux
- **Binary distribution**: Standalone executables with checksums
- **Semantic versioning**: vX.Y.Z with pre-release support

## Configuration System
```python
# Environment variables with IMGC_ prefix
ENV_TRUE_VALUES = {'true', '1', 'yes', 'on'}  # Explicit boolean parsing

# Extracted, testable parsing functions
def _env_bool(name, default=False):
    value = _env_str(name, 'false' if not default else 'true').lower()
    return value in ENV_TRUE_VALUES
```

## Testing Philosophy
- **Test actual implementation**: Import and test real functions, don't reimplement
- **Comprehensive coverage**: Unit tests, integration tests, edge cases
- **Clean mocking**: Use pytest monkeypatch, avoid complex manual mocks
- **Real scenarios**: Use tmp_path for file operations, test cross-platform paths

## Common Development Patterns
```python
# Path handling
path = Path(user_input).resolve()
if not path.exists() or not path.is_dir():
    parser.error(f'Invalid directory: {path}')

# Threading
stop_event = threading.Event()
bg = threading.Thread(target=worker_func, args=(data,), daemon=True)

# Error handling
try:
    result = risky_operation()
except Exception as e:
    logger.warning('Operation failed for %s: %s', context, e)
    return None

# Configuration
env_value = _env_bool('IMGC_OPTION', config.DEFAULT_OPTION)
```

## Quality Standards
- Type hints for all function signatures
- Docstrings for all public functions
- Comprehensive error handling with logging
- Cross-platform compatibility testing
- Environment variable support for all options
- Clear, helpful error messages for users

## Performance Characteristics
- **Lightweight**: Minimal resource usage when idle
- **Efficient**: Event-driven processing, no polling
- **Scalable**: Multi-threaded batch processing
- **Responsive**: Fast startup in watch-only mode
- **Robust**: Timeout handling prevents hanging

## Maintenance Considerations
- Keep requirements.txt minimal and well-documented
- Update PyInstaller hidden imports when adding dependencies
- Test changes on multiple platforms before release
- Document breaking changes prominently in CHANGELOG.md
- Maintain backward compatibility where possible

## Recent Problem-Solving Examples
1. **Threading test issues**: Fixed by improving testability (extracting stop_event parameter)
2. **Windows path problems**: Solved with proper path normalization using Path.resolve()
3. **PyInstaller PIL errors**: Fixed with --collect-submodules PIL and better hidden imports
4. **Cross-platform builds**: Addressed ARM64 limitations with clear documentation
5. **Testing anti-patterns**: Improved by testing actual implementation vs reimplementation

## Future Enhancement Opportunities
- Configuration file support for complex setups
- Plugin architecture for additional image formats
- Performance monitoring and optimization
- Integration with cloud storage services
- GUI interface for non-technical users
- Docker containerization for server deployments

## Documentation Standards
- README.md: User-facing documentation with clear examples
- CHANGELOG.md: Following Keep a Changelog format
- copilot-instructions.md: Code review guidelines for AI assistance
- Inline docstrings: Type information and behavior description
- Migration guides: For breaking changes

This project demonstrates excellent software engineering practices with a focus on reliability, cross-platform compatibility, and maintainable code.
